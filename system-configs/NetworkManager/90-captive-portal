#!/bin/bash
# Captive Portal Auto-Open Script
# Opens browser when NetworkManager detects captive portal
# Supports both X11 (i3) and Wayland (Sway/Hyprland)

LOG="/tmp/captive-portal.log"
log() { echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG"; }

interface="$1"
status="$2"

# Only act on connectivity-change events
if [ "$status" != "connectivity-change" ]; then
    exit 0
fi

log "Connectivity change detected on $interface"

# Check if we're in portal state
connectivity="${CONNECTIVITY_STATE:-$(nmcli -t -f CONNECTIVITY general 2>/dev/null)}"
log "Connectivity state: $connectivity (env: ${CONNECTIVITY_STATE:-not set})"

# Trigger on portal OR limited (some portals report as limited)
if [[ "$connectivity" =~ ^(PORTAL|portal|LIMITED|limited)$ ]]; then
    log "Portal detected, finding active graphical session..."
    
    # Find active graphical session using loginctl
    while read -r session_id; do
        [ -z "$session_id" ] && continue
        
        SESSION_TYPE=$(loginctl show-session "$session_id" -p Type --value 2>/dev/null)
        SESSION_STATE=$(loginctl show-session "$session_id" -p State --value 2>/dev/null)
        
        # Only consider active graphical sessions (x11 or wayland)
        if [[ "$SESSION_STATE" == "active" ]] && [[ "$SESSION_TYPE" =~ ^(x11|wayland)$ ]]; then
            DISPLAY_USER=$(loginctl show-session "$session_id" -p Name --value 2>/dev/null)
            USER_ID=$(loginctl show-session "$session_id" -p User --value 2>/dev/null)
            log "Found active $SESSION_TYPE session: $session_id, user: $DISPLAY_USER (uid: $USER_ID)"
            
            PORTAL_URL="http://neverssl.com"
            
            if [ "$SESSION_TYPE" = "x11" ]; then
                # X11 session (i3wm)
                DISPLAY_VAL=$(loginctl show-session "$session_id" -p Display --value 2>/dev/null)
                DISPLAY_VAL="${DISPLAY_VAL:-:0}"
                log "X11 mode: DISPLAY=$DISPLAY_VAL"
                log "Opening $PORTAL_URL for user $DISPLAY_USER"
                
                # Use runuser (designed for running commands as another user from root)
                runuser -u "$DISPLAY_USER" -- env \
                    DISPLAY="$DISPLAY_VAL" \
                    XAUTHORITY="/home/$DISPLAY_USER/.Xauthority" \
                    nohup xdg-open "$PORTAL_URL" >>"$LOG" 2>&1 &
                
                log "Browser launch initiated (X11)"
                
            elif [ "$SESSION_TYPE" = "wayland" ]; then
                # Wayland session (Sway/Hyprland)
                XDG_RUNTIME_DIR="/run/user/$USER_ID"
                WAYLAND_DISPLAY=$(ls "$XDG_RUNTIME_DIR"/wayland-* 2>/dev/null | head -1 | xargs basename 2>/dev/null)
                WAYLAND_DISPLAY="${WAYLAND_DISPLAY:-wayland-0}"
                log "Wayland mode: XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR, WAYLAND_DISPLAY=$WAYLAND_DISPLAY"
                log "Opening $PORTAL_URL for user $DISPLAY_USER"
                
                runuser -u "$DISPLAY_USER" -- env \
                    XDG_RUNTIME_DIR="$XDG_RUNTIME_DIR" \
                    WAYLAND_DISPLAY="$WAYLAND_DISPLAY" \
                    nohup xdg-open "$PORTAL_URL" >>"$LOG" 2>&1 &
                
                log "Browser launch initiated (Wayland)"
            fi
            
            # Only open for first active session found
            break
        fi
    done < <(loginctl list-sessions --no-legend 2>/dev/null | awk '{print $1}')
    
    # Check if we found any session
    if [ -z "$DISPLAY_USER" ]; then
        log "ERROR: No active graphical session found"
    fi
else
    log "Not in portal state ($connectivity), no action needed"
fi
