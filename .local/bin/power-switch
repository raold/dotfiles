#!/bin/bash
# Auto power profile switcher for Framework 13 AMD
# Triggered by: systemd at boot + udev on AC plug/unplug
# Uses powerprofilesctl as single source of truth for CPU/platform
#
# ppd profile mapping on amd-pstate-epp:
#   performance  → EPP=performance, platform=performance
#   balanced     → EPP=balance_performance, platform=balanced
#   power-saver  → EPP=power, platform=low-power

AC_ONLINE=$(cat /sys/class/power_supply/AC*/online 2>/dev/null || echo "0")
GPU_DPM="/sys/class/drm/card1/device/power_dpm_force_performance_level"

if [ "$AC_ONLINE" = "1" ]; then
    # ========== AC POWER ==========
    powerprofilesctl set performance

    # GPU: high performance
    [ -f "$GPU_DPM" ] && echo "high" > "$GPU_DPM" 2>/dev/null

    logger "power-switch: AC — performance (ppd=performance, GPU=high)"
else
    # ========== BATTERY ==========
    powerprofilesctl set balanced

    # GPU: auto (driver manages frequency based on load)
    [ -f "$GPU_DPM" ] && echo "auto" > "$GPU_DPM" 2>/dev/null

    # Extra battery tuning (not managed by ppd)
    # Audio: 5 second codec power-down timeout
    echo 5 > /sys/module/snd_hda_intel/parameters/power_save 2>/dev/null

    # NVMe: auto power management
    for nvme in /sys/class/nvme/*/device/power/control; do
        echo auto > "$nvme" 2>/dev/null
    done

    logger "power-switch: Battery — balanced (ppd=balanced, GPU=auto)"
fi

# Call WM-specific power script as user dro (non-blocking)
# runuser doesn't need sudoers, unlike sudo -u
if [ -x /home/dro/.local/bin/hyprland-power-switch ]; then
    MODE=$( [ "$AC_ONLINE" = "1" ] && echo "ac" || echo "battery" )
    runuser -u dro -- /home/dro/.local/bin/hyprland-power-switch "$MODE" &
fi
