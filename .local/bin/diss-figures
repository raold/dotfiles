#!/usr/bin/env bash
# diss-figures - Manage dissertation figures (crop, list, optimize)
# Usage: diss-figures [command] [args]
#   list              - List all figures with sizes
#   crop [file.pdf]   - Crop whitespace from PDF figures
#   crop-all          - Crop all PDF figures in figures/ directory
#   optimize          - Optimize PNG figures for smaller file size

set -euo pipefail

DISS_DIR="${DISS_DIR:-$HOME/rice/nfl-analytics/analysis/dissertation}"
FIG_DIR="$DISS_DIR/figures"

cd "$DISS_DIR"

case "${1:-list}" in
    list)
        echo "ðŸ“Š Dissertation Figures"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "By directory:"
        find "$FIG_DIR" -type d | while read dir; do
            count=$(find "$dir" -maxdepth 1 -type f \( -name "*.pdf" -o -name "*.png" -o -name "*.jpg" \) 2>/dev/null | wc -l)
            if [[ $count -gt 0 ]]; then
                size=$(du -sh "$dir" 2>/dev/null | cut -f1)
                echo "  $(basename "$dir"): $count files ($size)"
            fi
        done
        echo ""
        echo "Total figures by type:"
        echo -n "  PDF: "; find "$FIG_DIR" -name "*.pdf" 2>/dev/null | wc -l
        echo -n "  PNG: "; find "$FIG_DIR" -name "*.png" 2>/dev/null | wc -l
        echo -n "  JPG: "; find "$FIG_DIR" -name "*.jpg" -o -name "*.jpeg" 2>/dev/null | wc -l
        echo ""
        echo "Largest figures:"
        find "$FIG_DIR" -type f \( -name "*.pdf" -o -name "*.png" \) -exec du -h {} \; 2>/dev/null | sort -rh | head -10
        ;;

    crop)
        FILE="${2:-}"
        if [[ -z "$FILE" ]]; then
            echo "Usage: diss-figures crop <file.pdf>"
            exit 1
        fi
        if [[ ! -f "$FILE" ]]; then
            echo "âŒ File not found: $FILE"
            exit 1
        fi
        echo "Cropping: $FILE"
        BACKUP="${FILE%.pdf}-uncropped.pdf"
        cp "$FILE" "$BACKUP"
        pdfcrop "$FILE" "$FILE"
        echo "âœ… Cropped. Backup: $BACKUP"
        ;;

    crop-all)
        echo "ðŸ”„ Cropping all PDF figures..."
        find "$FIG_DIR" -name "*.pdf" ! -name "*-uncropped.pdf" | while read f; do
            echo "  Cropping: $(basename "$f")"
            pdfcrop "$f" "$f" >/dev/null 2>&1
        done
        echo "âœ… Done"
        ;;

    optimize)
        echo "ðŸ”„ Optimizing PNG figures..."
        command -v optipng >/dev/null || { echo "optipng not installed. Run: sudo pacman -S optipng"; exit 1; }
        find "$FIG_DIR" -name "*.png" | while read f; do
            SIZE_BEFORE=$(stat -c%s "$f")
            optipng -quiet "$f" 2>/dev/null
            SIZE_AFTER=$(stat -c%s "$f")
            SAVED=$((SIZE_BEFORE - SIZE_AFTER))
            if [[ $SAVED -gt 0 ]]; then
                echo "  $(basename "$f"): saved $(numfmt --to=iec $SAVED)"
            fi
        done
        echo "âœ… Done"
        ;;

    *)
        echo "Usage: diss-figures [list|crop|crop-all|optimize]"
        exit 1
        ;;
esac
