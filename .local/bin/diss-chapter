#!/usr/bin/env bash
# diss-chapter - Compile individual dissertation chapters
# Usage:
#   diss-chapter build <num>     Build chapter N once
#   diss-chapter watch <num>     Watch chapter N for changes
#   diss-chapter list            List all chapters
#   diss-chapter clean <num>     Clean chapter N build files

set -euo pipefail

DISS_DIR="${DISS_DIR:-$HOME/rice/nfl-analytics/analysis/dissertation}"
MAIN_DIR="$DISS_DIR/main"

# Map chapter numbers to directory names
get_chapter_dir() {
    local num="$1"
    local padded=$(printf "%02d" "$num")

    # Find matching chapter directory
    local dir=$(find "$DISS_DIR" -maxdepth 1 -type d -name "chapter_${padded}_*" 2>/dev/null | head -1)

    if [[ -z "$dir" ]]; then
        # Try without padding
        dir=$(find "$DISS_DIR" -maxdepth 1 -type d -name "chapter_${num}_*" 2>/dev/null | head -1)
    fi

    echo "$dir"
}

# Get chapter .tex file
get_chapter_tex() {
    local dir="$1"
    local basename=$(basename "$dir")
    echo "$dir/${basename}.tex"
}

# Generate standalone wrapper for a chapter
generate_wrapper() {
    local chapter_dir="$1"
    local chapter_tex="$2"
    local chapter_name=$(basename "$chapter_dir")
    local wrapper="$chapter_dir/standalone.tex"
    local rel_main="../main"

    cat > "$wrapper" << 'PREAMBLE_START'
% Standalone wrapper for chapter compilation
% Auto-generated by diss-chapter - do not edit manually

\input{../style/chapter_preamble.tex}

\begin{document}
\singlespacing
\emergencystretch=3em

PREAMBLE_START

    # Extract chapter number and set counter
    local num=$(echo "$chapter_name" | grep -oP 'chapter_\K\d+' | sed 's/^0*//')
    if [[ -n "$num" ]]; then
        echo "\\setcounter{chapter}{$((num - 1))}" >> "$wrapper"
    fi

    # Add externaldocument for cross-references if xr package available
    cat >> "$wrapper" << EOF

% Cross-references: Run full dissertation build first for refs to resolve
% Undefined refs will show as [??] until main is compiled

% Include the actual chapter content
\input{$(basename "$chapter_tex")}

% Bibliography
\IfFileExists{$rel_main/references.bib}{%
  \bibliographystyle{plainnat}
  \bibliography{$rel_main/references}
}{}

\end{document}
EOF

    echo "$wrapper"
}

# Build a single chapter
build_chapter() {
    local num="$1"
    local chapter_dir=$(get_chapter_dir "$num")

    if [[ -z "$chapter_dir" || ! -d "$chapter_dir" ]]; then
        echo "âŒ Chapter $num not found"
        echo "Available chapters:"
        list_chapters
        exit 1
    fi

    local chapter_tex=$(get_chapter_tex "$chapter_dir")
    local chapter_name=$(basename "$chapter_dir")

    if [[ ! -f "$chapter_tex" ]]; then
        echo "âŒ Chapter tex file not found: $chapter_tex"
        exit 1
    fi

    echo "ðŸ“„ Building Chapter $num: $chapter_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # Generate wrapper
    local wrapper=$(generate_wrapper "$chapter_dir" "$chapter_tex")
    echo "â†’ Generated wrapper: $(basename "$wrapper")"

    # Compile
    cd "$chapter_dir"
    echo "â†’ Compiling..."

    if latexmk -pdf -interaction=nonstopmode -quiet "standalone.tex" 2>&1 | texlogsieve 2>/dev/null || \
       latexmk -pdf -interaction=nonstopmode -quiet "standalone.tex" 2>&1 | tail -20; then

        # Rename output to chapter name
        if [[ -f "standalone.pdf" ]]; then
            mv "standalone.pdf" "${chapter_name}.pdf"
            echo ""
            echo "âœ… Output: $chapter_dir/${chapter_name}.pdf"
            echo "   Size: $(du -h "${chapter_name}.pdf" | cut -f1)"
            echo "   Pages: $(pdfinfo "${chapter_name}.pdf" 2>/dev/null | grep Pages | awk '{print $2}')"
        fi
    else
        echo "âŒ Compilation failed"
        exit 1
    fi
}

# Watch a chapter for changes
watch_chapter() {
    local num="$1"
    local chapter_dir=$(get_chapter_dir "$num")

    if [[ -z "$chapter_dir" || ! -d "$chapter_dir" ]]; then
        echo "âŒ Chapter $num not found"
        exit 1
    fi

    local chapter_tex=$(get_chapter_tex "$chapter_dir")
    local chapter_name=$(basename "$chapter_dir")

    echo "ðŸ‘ï¸  Watching Chapter $num: $chapter_name"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Directory: $chapter_dir"
    echo "Press Ctrl+C to stop"
    echo ""

    # Generate wrapper first
    generate_wrapper "$chapter_dir" "$chapter_tex" > /dev/null

    cd "$chapter_dir"

    # Use latexmk continuous mode
    latexmk -pdf -pvc -interaction=nonstopmode "standalone.tex"
}

# List all chapters
list_chapters() {
    echo "ðŸ“š Dissertation Chapters"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    find "$DISS_DIR" -maxdepth 1 -type d -name "chapter_*" | sort | while read dir; do
        local name=$(basename "$dir")
        local num=$(echo "$name" | grep -oP 'chapter_\K\d+' | sed 's/^0*//')
        local tex_file=$(get_chapter_tex "$dir")
        local pdf_file="$dir/${name}.pdf"

        printf "  %2s. %s" "$num" "$name"

        if [[ -f "$pdf_file" ]]; then
            local mod_time=$(stat -c %Y "$pdf_file" 2>/dev/null)
            local tex_time=$(stat -c %Y "$tex_file" 2>/dev/null)

            if [[ "$mod_time" -ge "$tex_time" ]] 2>/dev/null; then
                echo " âœ“ ($(du -h "$pdf_file" | cut -f1))"
            else
                echo " âš  (stale)"
            fi
        else
            echo " â—‹ (not built)"
        fi
    done
}

# Clean chapter build files
clean_chapter() {
    local num="$1"
    local chapter_dir=$(get_chapter_dir "$num")

    if [[ -z "$chapter_dir" || ! -d "$chapter_dir" ]]; then
        echo "âŒ Chapter $num not found"
        exit 1
    fi

    local chapter_name=$(basename "$chapter_dir")

    echo "ðŸ§¹ Cleaning Chapter $num: $chapter_name"

    cd "$chapter_dir"

    # Remove build artifacts
    rm -f standalone.{aux,log,out,toc,bbl,blg,fls,fdb_latexmk,synctex.gz,pdf} 2>/dev/null || true
    rm -f "${chapter_name}.pdf" 2>/dev/null || true

    echo "âœ… Cleaned"
}

# Show help
show_help() {
    echo "diss-chapter - Compile individual dissertation chapters"
    echo ""
    echo "Usage:"
    echo "  diss-chapter build <num>     Build chapter N once"
    echo "  diss-chapter watch <num>     Watch chapter N for changes (continuous)"
    echo "  diss-chapter list            List all chapters and build status"
    echo "  diss-chapter clean <num>     Clean chapter N build files"
    echo "  diss-chapter clean-all       Clean all chapter build files"
    echo ""
    echo "Examples:"
    echo "  diss-chapter build 3         # Build chapter 3 (Data Foundation)"
    echo "  diss-chapter watch 5         # Watch chapter 5 for changes"
    echo "  diss-chapter list            # Show all chapters"
    echo ""
    echo "Notes:"
    echo "  - Chapter PDFs are saved in each chapter's folder"
    echo "  - Cross-references from main.aux are imported automatically"
    echo "  - Run 'diss-watch' first to generate main.aux for full cross-refs"
}

# Main command dispatch
case "${1:-help}" in
    build)
        if [[ -z "${2:-}" ]]; then
            echo "Usage: diss-chapter build <chapter_number>"
            exit 1
        fi
        build_chapter "$2"
        ;;
    watch)
        if [[ -z "${2:-}" ]]; then
            echo "Usage: diss-chapter watch <chapter_number>"
            exit 1
        fi
        watch_chapter "$2"
        ;;
    list)
        list_chapters
        ;;
    clean)
        if [[ -z "${2:-}" ]]; then
            echo "Usage: diss-chapter clean <chapter_number>"
            exit 1
        fi
        clean_chapter "$2"
        ;;
    clean-all)
        echo "ðŸ§¹ Cleaning all chapters..."
        find "$DISS_DIR" -maxdepth 1 -type d -name "chapter_*" | while read dir; do
            local num=$(echo "$(basename "$dir")" | grep -oP 'chapter_\K\d+' | sed 's/^0*//')
            clean_chapter "$num" 2>/dev/null || true
        done
        echo "âœ… All chapters cleaned"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Unknown command: $1"
        show_help
        exit 1
        ;;
esac
