#!/usr/bin/env bash
# diss-lint - Check dissertation for LaTeX issues
# Usage: diss-lint [main.tex]

set -euo pipefail

DISS_DIR="${DISS_DIR:-$HOME/rice/nfl-analytics/analysis/dissertation/main}"
MAIN_TEX="${1:-main.tex}"

cd "$DISS_DIR"

echo "ðŸ” Linting Dissertation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ChkTeX - main linter
echo "ðŸ“‹ ChkTeX Warnings (top issues)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
chktex -q "$MAIN_TEX" 2>&1 | head -30 || true
CHKTEX_COUNT=$(chktex -q "$MAIN_TEX" 2>&1 | wc -l)
echo ""
echo "Total chktex warnings: $CHKTEX_COUNT"
echo ""

# LaCheck - additional checks
echo "ðŸ“‹ LaCheck Warnings"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
lacheck "$MAIN_TEX" 2>&1 | head -20 || true
LACHECK_COUNT=$(lacheck "$MAIN_TEX" 2>&1 | wc -l)
echo ""
echo "Total lacheck warnings: $LACHECK_COUNT"
echo ""

# Common issues to grep for
echo "ðŸ“‹ Common Issues"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Check for common typos/issues
echo -n "Double spaces: "
grep -rn "  " --include="*.tex" . 2>/dev/null | wc -l

echo -n "TODO/FIXME comments: "
grep -rni "TODO\|FIXME\|XXX" --include="*.tex" . 2>/dev/null | wc -l

echo -n "Undefined references: "
grep -i "undefined" *.log 2>/dev/null | wc -l || echo "0"

echo -n "Missing citations: "
grep -i "citation.*undefined" *.log 2>/dev/null | wc -l || echo "0"

echo -n "Overfull hboxes: "
grep -c "Overfull.*hbox" *.log 2>/dev/null || echo "0"

echo -n "Underfull hboxes: "
grep -c "Underfull.*hbox" *.log 2>/dev/null || echo "0"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Show TODOs if any
TODOS=$(grep -rni "TODO\|FIXME\|XXX" --include="*.tex" . 2>/dev/null | head -10)
if [[ -n "$TODOS" ]]; then
    echo ""
    echo "ðŸ“Œ TODOs/FIXMEs found:"
    echo "$TODOS"
fi
